import pyvisa
import numpy as np
import matplotlib.pyplot as plt
from scipy.signal import welch # Importa la función welch para el cálculo de la Densidad Espectral de Potencia (PSD)

# Parámetros de configuración
N9000B_IP = '169.254.192.72'  # Dirección IP del analizador de espectro Keysight N9000B
VISA_TIMEOUT_MS = 15000      # Tiempo de espera para operaciones VISA en milisegundos (15 segundos)

def main():
    """
    Función principal para la conexión al instrumento, adquisición de datos IQ,
    cálculo de PSD y visualización.
    """
    rm = None  # Inicializa rm a None para asegurar que se cierre correctamente en finally
    inst = None # Inicializa inst a None para asegurar que se cierre correctamente en finally
    try:
        # Inicializar el administrador de recursos PyVISA
        rm = pyvisa.ResourceManager('@py')
        # Abrir la conexión con el instrumento usando su dirección IP
        inst = rm.open_resource(f'TCPIP::{N9000B_IP}::INSTR')
        # Establecer el tiempo de espera para la comunicación con el instrumento
        inst.timeout = VISA_TIMEOUT_MS

        # Consultar la identificación del instrumento para verificar la conexión
        print("Conectado a:", inst.query('*IDN?').strip())
        # Limpiar cualquier error previo en el instrumento
        inst.write('*CLS')

        # --- Configuración y Adquisición de la Forma de Onda IQ (según el manual) ---
        print("Configurando la medición de forma de onda IQ...")
        # Configura el instrumento para la medición de forma de onda IQ.
        inst.write(':CONFigure:WAVeform')

        print("Iniciando la adquisición de forma de onda IQ...")
        # Inicia una única adquisición de la forma de onda IQ.
        inst.write(':INITiate:WAVeform')

        # Esperar a que la operación anterior se complete.
        # '*OPC?' consulta el bit de "Operación Completa" y espera a que el instrumento lo envíe.
        opc = inst.query('*OPC?')
        if opc.strip() != '1':
            raise RuntimeError("Adquisición de forma de onda IQ no completada. El instrumento no indicó la finalización.")

        # Intentar leer el vector de datos IQ (waveform) en formato RAW (float)
        print("Leyendo datos IQ waveform con :FETCh:WAVeform? ...")
        # ':FETCh:WAVeform?' solicita los datos de la forma de onda IQ.
        # 'datatype='f'' especifica que los datos son de tipo float.
        # 'is_big_endian=False' indica que los datos no están en formato big-endian (little-endian).
        iq_data = inst.query_binary_values(':FETCh:WAVeform?', datatype='f', is_big_endian=False)

        iq_data = np.array(iq_data)
        print(iq_data.shape)

    except Exception as e:
        # Captura y muestra cualquier error general que ocurra
        print(f"Error: {e}")
        # Intentar consultar el último error SCPI del instrumento si la conexión está activa
        if inst:
            try:
                print("Consulta error SCPI del instrumento:", inst.query('SYSTem:ERRor?').strip())
            except Exception as err_scpi:
                print(f"No se pudo consultar el error SCPI: {err_scpi}")
    finally:
        # Asegura que la conexión con el instrumento se cierre, incluso si ocurre un error
        if inst: # Verifica si la variable 'inst' ha sido definida y no es None
            inst.close()
            print("Conexión cerrada.")
        if rm: # Cierra el administrador de recursos PyVISA
            rm.close()
            print("Administrador de recursos PyVISA cerrado.")

# Punto de entrada del script
if __name__ == "__main__":
    main()
